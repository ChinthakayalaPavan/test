<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Bingo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: url("https://img.freepik.com/free-vector/realistic-hexagonal-background_79603-1646.jpg") no-repeat center center fixed;
      background-size: cover;
      color: white;
    }
    h1 { margin-top: 20px; text-shadow: 2px 2px 5px black; }
    .board {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 5px;
      justify-content: center;
      margin: 20px auto;
    }
    .cell {
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: blue;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
    }
    .cell.selected { background: green; }
    #opponentBoard { margin-top: 30px; display: none; }
    #status { margin: 15px; font-size: 18px; }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      background: orange;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    #preGameControls { margin-top: 15px; }
    #bingoStatus {
      font-size: 32px;
      letter-spacing: 15px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .bingoLetter { color: gray; text-shadow: 1px 1px 3px black; transition: all 0.3s ease; }
    .bingoLetter.glow { color: yellow; text-shadow: 0 0 10px yellow, 0 0 20px orange; }
  </style>
</head>
<body>
  <h1>🎉 Multiplayer Bingo 🎉</h1>
  <div id="status">Connecting to game...</div>

  <div id="bingoStatus">
    <span id="letterB" class="bingoLetter">B</span>
    <span id="letterI" class="bingoLetter">I</span>
    <span id="letterN" class="bingoLetter">N</span>
    <span id="letterG" class="bingoLetter">G</span>
    <span id="letterO" class="bingoLetter">O</span>
  </div>

  <h2 id="playerTitle">Your Board</h2>
  <div id="playerBoard" class="board"></div>

  <div id="preGameControls">
    <button id="reshuffleBtn">🔄 Re-shuffle</button>
    <button id="okBtn">✅ OK</button>
  </div>

  <h2 id="opponentTitle">Opponent's Board</h2>
  <div id="opponentBoard" class="board"></div>

  <button id="playAgain" style="display:none;">Play Again</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, push, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_v8PrYl2_3mUETzk-JYTxm3-YdE5FzE4",
      authDomain: "bingo-multiplayer-2b0de.firebaseapp.com",
      databaseURL: "https://bingo-multiplayer-2b0de-default-rtdb.firebaseio.com/",
      projectId: "bingo-multiplayer-2b0de",
      storageBucket: "bingo-multiplayer-2b0de.appspot.com",
      messagingSenderId: "363457734024",
      appId: "1:363457734024:web:56ddb17e0313fd8283463d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let playerId = "player_" + Math.floor(Math.random() * 1000000);
    let gameId = null;
    let playerRole = null;
    let boardNumbers = [];
    let opponentNumbers = [];
    let myTurn = false;
    let gameOver = false;
    let ready = false;

    const statusDiv = document.getElementById("status");
    const playerBoardDiv = document.getElementById("playerBoard");
    const opponentBoardDiv = document.getElementById("opponentBoard");
    const playAgainBtn = document.getElementById("playAgain");
    const reshuffleBtn = document.getElementById("reshuffleBtn");
    const okBtn = document.getElementById("okBtn");
    const preGameControls = document.getElementById("preGameControls");
    const playerTitle = document.getElementById("playerTitle");
    const opponentTitle = document.getElementById("opponentTitle");

    const bingoLetters = [
      document.getElementById("letterB"),
      document.getElementById("letterI"),
      document.getElementById("letterN"),
      document.getElementById("letterG"),
      document.getElementById("letterO")
    ];

    // 👇 Read unique name from localStorage
    const myUniqueName = localStorage.getItem("bingoUniqueName") || "You";
    
    playerTitle.textContent = myUniqueName + " - Your Board";

     
    

    function generateBoard() {
      let nums = [...Array(25).keys()].map(n => n + 1);
      for (let i = nums.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [nums[i], nums[j]] = [nums[j], nums[i]];
      }
      return nums;
    }

    function renderBoard(boardDiv, numbers, clickable) {
      boardDiv.innerHTML = "";
      numbers.forEach((num, i) => {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = num;
        if (clickable && ready) {
          cell.addEventListener("click", () => handleCellClick(i, cell));
        }
        boardDiv.appendChild(cell);
      });
    }

    function applySelections(boardDiv, numbers, selectedSet) {
      if (!selectedSet) return;
      const cells = [...boardDiv.children];
      for (let i = 0; i < numbers.length; i++) {
        if (selectedSet.has(numbers[i])) {
          cells[i]?.classList.add("selected");
        }
      }
    }

    function handleCellClick(index, cell) {
      if (!myTurn || gameOver) return;
      if (cell.classList.contains("selected")) return;
      cell.classList.add("selected");
      sendMove(boardNumbers[index]);
    }

    async function sendMove(number) {
      await update(ref(db, "games/" + gameId + "/selected"), { [number]: true });
      await update(ref(db, "games/" + gameId), {
        lastMove: number,
        turn: playerRole === "P1" ? "P2" : "P1"
      });
    }

    function checkWin(numbers, selectedSet, updateLetters = false) {
      let winCount = 0;
      for (let r = 0; r < 5; r++) {
        if (numbers.slice(r*5, r*5+5).every(n => selectedSet.has(n))) winCount++;
      }
      for (let c = 0; c < 5; c++) {
        if ([0,1,2,3,4].every(r => selectedSet.has(numbers[r*5+c]))) winCount++;
      }
      if ([0,6,12,18,24].every(i => selectedSet.has(numbers[i]))) winCount++;
      if ([4,8,12,16,20].every(i => selectedSet.has(numbers[i]))) winCount++;

      if (updateLetters) {
        for (let i = 0; i < 5; i++) {
          if (i < winCount) bingoLetters[i].classList.add("glow");
          else bingoLetters[i].classList.remove("glow");
        }
      }
      return winCount >= 5;
    }

    async function joinGame() {
      const queueRef = ref(db, "queue");
      const snap = await get(queueRef);

      if (!snap.exists()) {
        await set(queueRef, { waiting: playerId });
        statusDiv.textContent = "Waiting for opponent...";
      } else {
        const waitingId = snap.val().waiting;
        if (waitingId && waitingId !== playerId) {
          gameId = "game_" + Date.now();
          playerRole = "P1";
          boardNumbers = generateBoard();

          await set(ref(db, "games/" + gameId), {
            P1: { id: playerId, board: boardNumbers, ready: false, active: true, name: myUniqueName },
            P2: { id: waitingId, ready: false, active: true },
            turn: "P1",
            lastMove: null,
            winner: null,
            selected: {}
          });

          onDisconnect(ref(db, "games/" + gameId + "/P1/active")).set(false);

          await remove(queueRef);
          startGame(gameId, playerRole);
        } else {
          statusDiv.textContent = "Waiting for opponent...";
        }
      }

      onValue(ref(db, "games"), (snap) => {
        snap.forEach(gameSnap => {
          const g = gameSnap.val();
          if (g.P2 && g.P2.id === playerId && !gameId) {
            gameId = gameSnap.key;
            playerRole = "P2";
            opponentNumbers = g.P1.board;
            boardNumbers = generateBoard();
            update(ref(db, "games/" + gameId + "/P2"), { board: boardNumbers, ready: false, active: true, name: myUniqueName });

            onDisconnect(ref(db, "games/" + gameId + "/P2/active")).set(false);

            startGame(gameId, playerRole);
          }
        });
      });
    }

    function startGame(gId, role) {
      boardNumbers = boardNumbers.length ? boardNumbers : generateBoard();
      renderBoard(playerBoardDiv, boardNumbers, false);

      reshuffleBtn.addEventListener("click", () => {
        if (ready) return;
        boardNumbers = generateBoard();
        renderBoard(playerBoardDiv, boardNumbers, false);
        update(ref(db, "games/" + gId + "/" + role), { board: boardNumbers });
      });

      okBtn.addEventListener("click", () => {
        if (ready) return;
        ready = true;
        renderBoard(playerBoardDiv, boardNumbers, true);
        update(ref(db, "games/" + gId + "/" + role), { board: boardNumbers, ready: true });
        statusDiv.textContent = "Waiting for opponent to press OK...";
      });

      onValue(ref(db, "games/" + gId), (snap) => {
        const g = snap.val();
        if (!g) return;

        // update opponent name
        if (role === "P1" && g.P2?.name) {
          opponentTitle.textContent = g.P2.name + " - Opponent's Board";
        }
        if (role === "P2" && g.P1?.name) {
          opponentTitle.textContent = g.P1.name + " - Opponent's Board";
        }

        if (role === "P1") opponentNumbers = g.P2.board || [];
        if (role === "P2") opponentNumbers = g.P1.board || [];

        const selectedSet = new Set(g.selected ? Object.keys(g.selected).map(n => parseInt(n)) : []);
        applySelections(playerBoardDiv, boardNumbers, selectedSet);

        const bothReady = g.P1?.ready && g.P2?.ready;
        if (!bothReady) {
          statusDiv.textContent = "Waiting for both players to confirm boards...";
          return;
        }

        preGameControls.style.display = "none";
        myTurn = g.turn === role;
        if (!gameOver) statusDiv.textContent = myTurn ? "Your turn!" : "Opponent's turn...";

        if (g.lastMove) {
          [...playerBoardDiv.children].forEach(cell => {
            if (parseInt(cell.textContent) === g.lastMove) cell.classList.add("selected");
          });
        }

        if (!gameOver) {
          if (role === "P1" && g.P2 && g.P2.active === false) {
            update(ref(db, "games/" + gId), { winner: "P1" });
          }
          if (role === "P2" && g.P1 && g.P1.active === false) {
            update(ref(db, "games/" + gId), { winner: "P2" });
          }
        }

        if (!gameOver) {
          if (myTurn && checkWin(boardNumbers, selectedSet, true)) {
            update(ref(db, "games/" + gameId), { winner: playerRole });
          }
        }

        if (g.winner && !gameOver) {
          gameOver = true;
          opponentBoardDiv.style.display = "grid";
          renderBoard(opponentBoardDiv, opponentNumbers, false);
          applySelections(opponentBoardDiv, opponentNumbers, selectedSet);
          playAgainBtn.style.display = "block";
          statusDiv.textContent = "";

          if (g.winner === playerRole) {
            playerTitle.textContent = myUniqueName + " - You Win 🎉";
            opponentTitle.textContent += " - Loss ❌";
          } else {
            playerTitle.textContent = myUniqueName + " - You Loss ❌";
            opponentTitle.textContent += " - Win 🎉";
          }
        }
      });
    }

    playAgainBtn.addEventListener("click", () => { location.reload(); });

    joinGame();
  </script>
</body>
</html>
